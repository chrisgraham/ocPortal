<?php /*

 ocPortal
 Copyright (c) ocProducts, 2004-2014

 See text/EN/licence.txt for full licencing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

/**
 * @license    http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright  ocProducts Ltd
 * @package    core
 */

/**
 * Standard code module initialisation function.
 */
function init__site()
{
    global $REQUEST_PAGE_NEST_LEVEL;
    $REQUEST_PAGE_NEST_LEVEL = 0;

    global $REDIRECTED_TO_CACHE;
    $REDIRECTED_TO_CACHE = null;

    // Get ready for breadcrumbs
    $bcl = get_option('breadcrumb_crop_length');
    define('BREADCRUMB_CROP_LENGTH', intval($bcl));

    global $NON_CANONICAL_PARAMS;
    // We only bother listing ones the software itself may inject - otherwise admin responsible for their own curation of canonical settings
    $NON_CANONICAL_PARAMS = array('wide_high', 'wide', 'wide_print', 'filtered', 'utheme', 'active_filter', 'redirected', 'redirect_url', 'redirect', 'redirect_passon');
    inform_non_canonical_parameter('#^(.*_)?(max|start|sort)$#');
    if (function_exists('get_value')) {
        $is_non_canonical = false;
        $canonical_keep_params = explode(',', is_null(get_value('canonical_keep_params')) ? 'keep_devtest' : get_value('canonical_keep_params'));
        foreach (array_keys($_GET) + array('keep_session'/*may be inserted later*/) as $key) {
            if ((is_string($key)) && (substr($key, 0, 5) == 'keep_') && (!@in_array($key, $canonical_keep_params))) {
                $NON_CANONICAL_PARAMS[] = $key;
                $is_non_canonical = true;
            }
        }
        if (($is_non_canonical) && (get_bot_type() !== null)) { // Force bots onto the canonical URL if there were non-standard keep parameters, as they may ignore even the canonical meta tag.
            $non_canonical = array();
            if (is_array($NON_CANONICAL_PARAMS)) {
                foreach ($NON_CANONICAL_PARAMS as $n) {
                    $non_canonical[$n] = null;
                }
            }
            set_http_status_code('301');
            header('HTTP/1.0 301 Moved Permanently'); // Direct ascending for short URLs - not possible, so should give 404's to avoid indexing
            header('Location: ' . get_self_url(true, false, $non_canonical));
            exit();
        }
    }

    global $PAGE_STRING, $LAST_COMCODE_PARSED_TITLE;
    $PAGE_STRING = null;
    $LAST_COMCODE_PARSED_TITLE = '';

    global $PT_PAIR_CACHE_CP;
    $PT_PAIR_CACHE_CP = array();

    global $ATTACH_MESSAGE_CALLED;
    $ATTACH_MESSAGE_CALLED = 0;

    $real_zone = load_zone_data();

    // SEO redirection
    require_code('urls');
    if (can_try_mod_rewrite()) {
        $ruri = ocp_srv('REQUEST_URI');

        $url_scheme = get_option('url_scheme');
        if (($url_scheme == 'PG') || ($url_scheme == 'HTM')) {
            if ((!headers_sent()) && (running_script('index')) && ($GLOBALS['RELATIVE_PATH'] == get_zone_name()/*i.e. a proper zone*/) && (count($_POST) == 0) && ((strpos($ruri, '/pg/') === false) || ($url_scheme != 'PG')) && ((strpos($ruri, '.htm') === false) || ($url_scheme != 'HTM'))) {
                set_http_status_code('301');
                header('HTTP/1.0 301 Moved Permanently'); // Direct ascending for short URLs - not possible, so should give 404's to avoid indexing
                header('Location: ' . get_self_url(true));
                exit();
            }
        }
    }

    // Search engine having session in URL, we don't like this
    if ((get_bot_type() !== null) && (count($_POST) == 0) && (get_param('keep_session', null) !== null)) {
        set_http_status_code('301');
        header('Location: ' . get_self_url(true, false, array('keep_session' => null, 'keep_print' => null)));
        exit();
    }

    // Detect bad access domain
    if (!running_script('webdav')/*we may want to allow WebDAV to run on a different domain*/) {
        global $SITE_INFO;
        $access_host = preg_replace('#:.*#', '', ocp_srv('HTTP_HOST'));
        if (($access_host != '') && ((isset($_SERVER['HTTP_HOST'])) || (isset($_ENV['HTTP_HOST']))) && (!$GLOBALS['EXTERNAL_CALL'])) {
            $parsed_base_url = parse_url(get_base_url());

            if ((array_key_exists('host', $parsed_base_url)) && (strtolower($parsed_base_url['host']) != strtolower($access_host))) {
                if (!array_key_exists('ZONE_MAPPING_' . get_zone_name(), $SITE_INFO)) {
                    if ((!is_null($GLOBALS['FORUM_DRIVER'])) && ($GLOBALS['FORUM_DRIVER']->is_super_admin(get_member()))) {
                        attach_message(do_lang_tempcode('BAD_ACCESS_DOMAIN', escape_html($parsed_base_url['host']), escape_html($access_host)), 'warn');
                    }

                    header('Location: ' . str_replace($access_host, $parsed_base_url['host'], get_self_url_easy()));
                    exit();
                }
            }
        }
    }

    if (running_script('index')) {
        process_url_monikers(get_page_name());
    }

    // The most important security check
    global $SESSION_CONFIRMED_CACHE;
    get_member(); // Make sure we've loaded our backdoor if installed
    require_code('permissions');
    global $ZONE;
    if ($ZONE['zone_require_session'] == 1) {
        header('X-Frame-Options: SAMEORIGIN'); // Clickjacking protection
    }
    if (($ZONE['zone_name'] != '') && (!is_httpauth_login()) && ((get_session_id() == '') || ($SESSION_CONFIRMED_CACHE == 0)) && ($ZONE['zone_require_session'] == 1) && (get_page_name() != 'login')) {
        access_denied((($real_zone == 'data') || (has_zone_access(get_member(), $ZONE['zone_name']))) ? 'ZONE_ACCESS_SESSION' : 'ZONE_ACCESS', $ZONE['zone_name'], true);
    } else {
        if (($real_zone == 'data') || (has_zone_access(get_member(), $ZONE['zone_name']))) {
            if ((running_script('index')) && /*Actually we will allow Guest denying to the front page even though that is a bit weird ((get_page_name()!=$ZONE['zone_default_page']) || ($real_zone!='')) && */
                (!has_page_access(get_member(), get_page_name(), $ZONE['zone_name'], true))
            ) {
                access_denied('PAGE_ACCESS');
            }
        } else {
            if (get_page_name() != 'login') {
                access_denied('ZONE_ACCESS', $ZONE['zone_name'], true);
            }
        }
    }
}

/**
 * Load up details for the current zone.
 *
 * @return  ID_TEXT     The "real" zone name (not actually the zone name, but the zone name wants details to load for).
 */
function load_zone_data()
{
    global $ZONE, $RELATIVE_PATH;
    $zone_name = get_zone_name();
    $real_zone = (($RELATIVE_PATH == '_tests') || ($RELATIVE_PATH == 'data') || ($RELATIVE_PATH == 'data_custom')) ? get_param('zone', '') : $zone_name;
    /** A map of the current zone that is running.
     *
     * @global array $ZONE
     */
    if ($ZONE === null) {
        $ZONE = persistent_cache_get(array('ZONE', $real_zone));

        if ($ZONE === null) {
            $zones = $GLOBALS['SITE_DB']->query_select('zones', array('*'), array('zone_name' => $real_zone), '', 1);
            if ((!array_key_exists(0, $zones)) && (is_dir(get_file_base() . '/' . $real_zone . '/' . 'pages'))) {
                $map = array(
                    'zone_name' => $real_zone,
                    'zone_default_page' => 'start',
                    'zone_theme' => 'default',
                    'zone_require_session' => 0,
                );
                $map += insert_lang('zone_title', $real_zone, 1);
                $map += insert_lang('zone_header_text', $real_zone, 1);
                $GLOBALS['SITE_DB']->query_insert('zones', $map);
                $zones = $GLOBALS['SITE_DB']->query_select('zones', array('*'), array('zone_name' => $real_zone), '', 1);
            }
            if (array_key_exists(0, $zones)) {
                $ZONE = $zones[0];
                persistent_cache_set(array('ZONE', $real_zone), $ZONE);
            }
            if ($ZONE === null) {
                $zones = $GLOBALS['SITE_DB']->query_select('zones', array('*'), array('zone_name' => ''), '', 1);
                $ZONE = $zones[0];
                warn_exit(do_lang_tempcode('BAD_ZONE', escape_html($real_zone)));
            }
            unset($zones);
        }
    }

    global $REDIRECT_CACHE;
    $REDIRECT_CACHE = null;

    return $real_zone;
}

/**
 * Load up redirect cache.
 */
function load_redirect_cache()
{
    global $REDIRECT_CACHE;
    $REDIRECT_CACHE = array();

    $_zone = get_zone_name();
    $REDIRECT_CACHE = array($_zone => array());
    if (addon_installed('redirects_editor')) {
        $redirect = persistent_cache_get(array('REDIRECT', $_zone));
        if ($redirect === null) {
            $redirect = $GLOBALS['SITE_DB']->query_select('redirects', array('*')/*Actually for performance we will load all and cache them ,array('r_from_zone'=>$_zone)*/);
            persistent_cache_set(array('REDIRECT', $_zone), $redirect);
        }
        foreach ($redirect as $r) {
            if (($r['r_from_zone'] == $r['r_to_zone']) && ($r['r_from_page'] == $r['r_to_page'])) {
                continue;
            }

            $REDIRECT_CACHE[$r['r_from_zone']][$r['r_from_page']] = $r;
        }
    }
}

/**
 * Attach some extra JavaScript to <head>. Don't use this too commonly, it's not a 'tidy' way of doing things.
 *
 * @sets_output_state
 *
 * @param  mixed                        $data JavaScript to attach (Tempcode or string)
 */
function attach_to_javascript($data)
{
    global $JAVASCRIPT;
    if ($JAVASCRIPT === null) {
        $JAVASCRIPT = new Tempcode();
    }
    $JAVASCRIPT->attach($data);
}

/**
 * Attach some XHTML to the screen header.
 *
 * @sets_output_state
 *
 * @param  mixed                        $data XHTML to attach (Tempcode or string)
 */
function attach_to_screen_header($data)
{
    global $EXTRA_HEAD;
    if ($EXTRA_HEAD === null) {
        $EXTRA_HEAD = new Tempcode();
    }
    $EXTRA_HEAD->attach($data);
}

/**
 * Mark another parameter non-canonical, so that Google won't consider it when indexing URLs.
 *
 * @sets_output_state
 *
 * @param  ID_TEXT                      $param Parameter name
 */
function inform_non_canonical_parameter($param)
{
    global $NON_CANONICAL_PARAMS;

    if (substr($param, 0, 1) == '#') {
        foreach (array_keys($_GET) as $key) {
            if (preg_match($param, $key) != 0) {
                inform_non_canonical_parameter($key);
            }
        }
    } else {
        $NON_CANONICAL_PARAMS[] = $param;
    }
}

/**
 * Attach a message to the page output.
 *
 * @sets_output_state
 *
 * @param  mixed                        $message The type of special message
 * @param  ID_TEXT                      $type The template to use
 * @set    inform notice warn
 * @param  boolean                      $put_in_helper_panel Whether to put into the helper panel instead of the normal header area
 * @return string                       Blank string so it can be chained in the Tempcode compiler. You will rarely want to use this return value. It's kind of a failsafe.
 */
function attach_message($message, $type = 'inform', $put_in_helper_panel = false)
{
    if ((error_reporting() == 0) && ($type == 'warn')) {
        return ''; // Suppressing errors
    }

    static $am_looping = false;
    if ($am_looping) {
        return ''; // Was a lang lookup error and got in an infinite loop of attaching errors about missing lang errors (because each iteration causes a reevaluation of past messages)
    }
    $am_looping = true;

    global $ATTACH_MESSAGE_CALLED, $ATTACHED_MESSAGES, $ATTACHED_MESSAGES_RAW, $LATE_ATTACHED_MESSAGES;

    foreach ($ATTACHED_MESSAGES_RAW as $last) {
        if (array(strip_tags(is_object($last[0]) ? $last[0]->evaluate() : $last[0]), $last[1]) == array(strip_tags(is_object($message) ? $message->evaluate() : $message), $type)) {
            $am_looping = false;
            return ''; // Already shown
        }
    }

    $ATTACH_MESSAGE_CALLED++;
    if ($ATTACH_MESSAGE_CALLED > 5) {
        critical_error('EMERGENCY', is_object($message) ? $message->evaluate() : escape_html($message));
    }

    if (($type == 'warn') && (strlen(is_object($message) ? $message->evaluate() : $message) < 130)) {
        require_code('failure');

        $webservice_result = get_webservice_result($message);
        if ($webservice_result !== null) {
            if ((is_object($message)) && ($message->pure_lang)) {
                $message = $message->evaluate();
            } elseif (is_object($message)) {
                $message = escape_html($message->evaluate());
            } else {
                $message = escape_html($message);
            }
            $message = do_template('CROP_TEXT_MOUSE_OVER', array(
                '_GUID' => '36ccd2ff13867ed000a46f15df0a4a22',
                'TEXT_LARGE' => $webservice_result,
                'TEXT_SMALL' => protect_from_escaping($message),
            ));
            $message = protect_from_escaping($message);
        }
    }

    if ((get_param_integer('keep_fatalistic', 0) == 1) && ($type == 'warn')) {
        fatal_exit($message);
    }

    $message_tpl = do_template('MESSAGE', array(
        '_GUID' => 'ec843c8619d21fbeeb512686ea300a17',
        'TYPE' => $type,
        'MESSAGE' => is_string($message) ? escape_html($message) : $message
    ));

    if ($put_in_helper_panel) {
        set_helper_panel_text($message_tpl, true, false);
    } else {
        $ATTACHED_MESSAGES_RAW[] = array($message, $type);
        if ($GLOBALS['TEMPCODE_OUTPUT_STARTED']) {
            if ($LATE_ATTACHED_MESSAGES === null) {
                $LATE_ATTACHED_MESSAGES = new Tempcode();
            }
            $LATE_ATTACHED_MESSAGES->attach($message_tpl);
        } else {
            if ($ATTACHED_MESSAGES === null) {
                $ATTACHED_MESSAGES = new Tempcode();
            }
            $ATTACHED_MESSAGES->attach($message_tpl);
        }
    }

    $ATTACH_MESSAGE_CALLED--;

    if ($GLOBALS['REFRESH_URL'][0] != '') {
        $GLOBALS['SITE_DB']->query_insert('messages_to_render', array(
            'r_session_id' => get_session_id(),
            'r_message' => is_object($message) ? $message->evaluate() : escape_html($message),
            'r_type' => $type,
            'r_time' => time(),
        ));
    }

    $am_looping = false;
    return '';
}

/**
 * Get the relative URL to the logo for the current zone.
 *
 * @param  ?ID_TEXT                     $zone_name The zone being operated within (null: auto-detect)
 * @return URLPATH                      The relative URL to the logo for the current zone
 */
function get_logo_url($zone_name = null)
{
    if (!addon_installed('zone_logos')) {
        return find_theme_image('logo/-logo');
    }

    global $ZONE;
    if ($zone_name === null) {
        $zone_name = $ZONE['zone_name'];
    }

    $image = find_theme_image('logo/' . $zone_name . '-logo', true);
    if ($image == '') {// Fallback to welcome zone logo
        $image = find_theme_image('logo/-logo');
    }

    return $image;
}

/**
 * Get the tempcode for the breadcrumbs.
 *
 * @param  boolean                      $show_self Whether to show a self segment
 * @return tempcode                     The breadcrumbs
 */
function breadcrumbs($show_self = true)
{
    global $BREADCRUMB_SET_PARENTS, $BREADCRUMBS, $BREADCRUMB_EXTRA_SEGMENTS;

    if ($BREADCRUMBS === null) {
        $BREADCRUMBS = breadcrumbs_get_default_stub(($BREADCRUMB_EXTRA_SEGMENTS === null || $BREADCRUMB_EXTRA_SEGMENTS->is_empty()) && $show_self);
    }
    $out = new Tempcode();
    $out->attach($BREADCRUMBS);
    if (($BREADCRUMB_EXTRA_SEGMENTS !== null) && (!$BREADCRUMB_EXTRA_SEGMENTS->is_empty())) {
        if (!$out->is_empty()) {
            $out->attach(do_template('BREADCRUMB_SEPARATOR'));
        }
        $out->attach($BREADCRUMB_EXTRA_SEGMENTS);
    }

    // Substitutions
    $segment_substitutions = array();
    if ((addon_installed('breadcrumbs')) && (function_exists('xml_parser_create'))) {
        $data = persistent_cache_get('BREADCRUMBS');
        if ($data === null) {
            $data = @file_get_contents(get_custom_file_base() . '/data_custom/breadcrumbs.xml');
            if (($data === false) && (get_custom_file_base() != get_file_base())) {
                $data = @file_get_contents(get_file_base() . '/data_custom/breadcrumbs.xml');
            }
            if ($data === false) {
                $data = '';
            }

            persistent_cache_set('BREADCRUMBS', $data);
        }
        if (trim($data) != '') {
            require_code('breadcrumbs');
            $segment_substitutions = array_merge($segment_substitutions, load_breadcrumb_substitutions($out->evaluate(), $data));
        }
    }
    if (count($segment_substitutions) != 0) {
        $_out = $out->evaluate();
        foreach ($segment_substitutions as $from => $to) {
            $_out = preg_replace('~' . str_replace('~', '\~', $from) . '~Us', $to, $_out, 1);
        }
        return make_string_tempcode($_out);
    }
    return $out;
}

/**
 * Get the tempcode for the default breadcrumbs stub. This isn't entirely a default, because it does work with breadcrumb_set_parents. We refer to it as a default as it is possible to override the whole breadcrumbs environment via the special BREADCRUMBS global variable.
 *
 * @param  boolean                      $link_to_self_entrypoint Whether we'll be providing a link to where we are currently at
 * @return tempcode                     The default breadcrumb stub
 */
function breadcrumbs_get_default_stub($link_to_self_entrypoint = true)
{
    global $BREADCRUMB_SET_PARENTS, $DISPLAYED_TITLE, $BREADCRUMB_SET_SELF;
    $stub = new Tempcode();

    // Special hard-coded link to sitemap structure for Admin and CMS zones
    $zone = get_zone_name();
    if ((($zone == 'adminzone') || ($zone == 'cms')) && (get_option('deeper_admin_breadcrumbs') == '1')) {
        require_code('site_adminzone');
        adminzone_extend_breadcrumbs($stub);
    }

    // Specified parents
    foreach ($BREADCRUMB_SET_PARENTS as $bit) {
        list($entrypoint, $title) = $bit;
        $title = symbol_truncator(array(is_object($title) ? $title : escape_html($title), BREADCRUMB_CROP_LENGTH, '1', '1'), 'spread');

        if (!$stub->is_empty()) {
            $stub->attach(do_template('BREADCRUMB_SEPARATOR'));
        }
        if ($entrypoint === '') {
            $stub->attach($title);
        } else {
            if (is_object($entrypoint)) {
                $url = $entrypoint;
            } else {
                list($zone, $attributes,) = page_link_decode($entrypoint);
                $url = build_url($attributes, $zone);
            }
            $stub->attach(hyperlink($url, $title, false, false, do_lang_tempcode('GO_BACKWARDS_TO', @html_entity_decode(strip_tags(is_object($title) ? $title->evaluate() : $title), ENT_QUOTES, get_charset()))));
        }
    }

    // Self-link
    if ($link_to_self_entrypoint) {
        if (!$stub->is_empty()) {
            $stub->attach(do_template('BREADCRUMB_SEPARATOR'));
        }
        $title = ($BREADCRUMB_SET_SELF === null) ? $DISPLAYED_TITLE : $BREADCRUMB_SET_SELF;
        if ($title !== null) {
            $title = symbol_truncator(array(is_object($title) ? $title : escape_html($title), (strlen(strip_tags($stub->evaluate())) < BREADCRUMB_CROP_LENGTH) ? (BREADCRUMB_CROP_LENGTH * 2) : BREADCRUMB_CROP_LENGTH, '1', '1'), 'spread');
            if (((is_object($title)) && (!$title->is_empty())) || ((is_string($title)) && ($title != ''))) {
                $stub->attach('<span>');
                $stub->attach($title);
                $stub->attach('</span>');
            }
        }
    }

    return $stub;
}

/**
 * Add a segment to the breadcrumbs (if this isn't used, a default will be used for the stub).
 *
 * @sets_output_state
 *
 * @param  tempcode                     $segment The segment
 * @param  ?mixed                       $final_title The title of the follower of the segment OR an array as for breadcrumb_set_parents (null: implicit in $segment)
 */
function breadcrumb_add_segment($segment, $final_title = null)
{
    global $BREADCRUMB_EXTRA_SEGMENTS;

    if ($BREADCRUMB_EXTRA_SEGMENTS === null) {
        $BREADCRUMB_EXTRA_SEGMENTS = new Tempcode();
    }
    $BREADCRUMB_EXTRA_SEGMENTS->attach($segment);
    if ($final_title !== null) {
        if (is_array($final_title)) {
            foreach ($final_title as $bit) {
                list($entrypoint, $title) = $bit;
                $title = symbol_truncator(array(is_object($title) ? $title : escape_html($title), BREADCRUMB_CROP_LENGTH, '1', '1'), 'spread');

                $BREADCRUMB_EXTRA_SEGMENTS->attach(do_template('BREADCRUMB_SEPARATOR'));

                if ($entrypoint === '') {
                    $BREADCRUMB_EXTRA_SEGMENTS->attach($title);
                } else {
                    if (is_object($entrypoint)) {
                        $url = $entrypoint;
                    } else {
                        list($zone, $attributes,) = page_link_decode($entrypoint);
                        $url = build_url($attributes, $zone);
                    }
                    $BREADCRUMB_EXTRA_SEGMENTS->attach(hyperlink($url, $title, false, false, do_lang_tempcode('GO_BACKWARDS_TO', @html_entity_decode(strip_tags(is_object($title) ? $title->evaluate() : $title), ENT_QUOTES, get_charset()))));
                }
            }
        } else {
            $title = $final_title;
            $BREADCRUMB_EXTRA_SEGMENTS->attach(do_template('BREADCRUMB_SEPARATOR'));
            $title = symbol_truncator(array(is_object($title) ? $title : escape_html($title), BREADCRUMB_CROP_LENGTH, '1', '1'), 'spread');
            $BREADCRUMB_EXTRA_SEGMENTS->attach($title);
        }
    }
}

/**
 * Put a list of parents in for the breadcrumbs.
 *
 * @sets_output_state
 *
 * @param  array                        $parents The list of parent entry points (pairs: entry point, title)
 */
function breadcrumb_set_parents($parents)
{
    global $BREADCRUMB_SET_PARENTS;
    $BREADCRUMB_SET_PARENTS = $parents;
}

/**
 * Set the current title.
 *
 * @sets_output_state
 *
 * @param  tempcode                     $title The title
 */
function breadcrumb_set_self($title)
{
    global $BREADCRUMB_SET_SELF;
    $BREADCRUMB_SET_SELF = $title;
}

/**
 * Set the feed (RSS/Atom) URL.
 *
 * @sets_output_state
 *
 * @param  URLPATH                      $url The URL
 */
function set_feed_url($url)
{
    global $FEED_URL;
    $FEED_URL = $url;
}

/**
 * Set the helper panel text.
 *
 * @sets_output_state
 *
 * @param  tempcode                     $text The text
 * @param  boolean                      $append Whether to append
 * @param  boolean                      $put_in_box Whether to add a box around the parameter
 */
function set_helper_panel_text($text, $append = true, $put_in_box = true)
{
    if ($put_in_box) {
        $text = put_in_standard_box($text);
    }

    global $HELPER_PANEL_TEXT;
    if ($append) {
        if (is_string($HELPER_PANEL_TEXT)) {
            $HELPER_PANEL_TEXT = make_string_tempcode($HELPER_PANEL_TEXT);
        }
        $HELPER_PANEL_TEXT->attach($text);
    } else {
        $HELPER_PANEL_TEXT = $text;
    }
}

/**
 * Set the helper panel tutorial.
 *
 * @sets_output_state
 *
 * @param  ID_TEXT                      $tutorial The page name of the tutorial (must be an existing one on the brand site, i.e. ocPortal.com)
 */
function set_helper_panel_tutorial($tutorial)
{
    global $HELPER_PANEL_TUTORIAL;
    $HELPER_PANEL_TUTORIAL = $tutorial;
}

/**
 * Sets the short title, used for screen header text if set.
 * Does not do anything if output streaming is on and already started.
 *
 * @sets_output_state
 *
 * @param  string                       $title The short title
 */
function set_short_title($title)
{
    global $SHORT_TITLE;
    $SHORT_TITLE = ($title == '') ? null : $title;
}

/**
 * Process URL monikers, changing 'id' GET param to be correct.
 *
 * @param  ID_TEXT                      $page The page name to do it for
 * @param  boolean                      $redirect_if_non_canonical Do a redirect if we're not on the canonical URL
 */
function process_url_monikers($page, $redirect_if_non_canonical = true)
{
    $zone = get_zone_name();
    $type = get_param('type', null, true);
    $url_id = get_param('id', null, true);

    if (url_monikers_enabled()) {
        // Monikers relative to the zone
        $page_place = _request_page($page, $zone);
        if ($page_place[0] == 'REDIRECT') {
            $zone = $page_place[1]['r_to_zone'];
            $page_place = _request_page($page_place[1]['r_to_page'], $page_place[1]['r_to_zone']);
        }
        if (($page_place === false) || ((substr($page_place[0], 0, 7) == 'COMCODE') && ($type !== null/*looking deeper than a normal Comcode page*/))) {
            // Reassemble source URL moniker from incorrectly-derived URL components
            $url_moniker = '';
            $url_moniker .= $page;
            if ($type !== null) {
                $url_moniker .= '/' . $type;
            }
            if ($url_id !== null) {
                $url_moniker .= '/' . $url_id;
            }

            // ... and query it
            $sql = 'SELECT m_resource_page,m_resource_type,m_resource_id FROM ' . get_table_prefix() . 'url_id_monikers WHERE ' . db_string_equal_to('m_moniker', '/' . $url_moniker) . ' OR ' . db_string_equal_to('m_moniker', $url_moniker) . ' AND ' . db_string_equal_to('m_resource_type', '') . ' AND ' . db_string_equal_to('m_resource_id', $zone);
            $test = $GLOBALS['SITE_DB']->query($sql, 1);
            if (array_key_exists(0, $test)) {
                if (_request_page($test[0]['m_resource_page'], $zone) !== false) { // ... if operable within the zone we're in
                    // Bind to correct new values
                    global $PAGE_NAME_CACHE;
                    $PAGE_NAME_CACHE = null;
                    if ($test[0]['m_resource_type'] == '') {
                        $_GET['page'] = $test[0]['m_resource_page'];
                        unset($_GET['type']);
                        unset($_GET['id']);
                    } else {
                        $_GET['page'] = $test[0]['m_resource_page'];
                        $_GET['type'] = $test[0]['m_resource_type'];
                        $_GET['id'] = $test[0]['m_resource_id'];
                    }
                    return;
                }
            }
        }

        // Yet more SEO redirection (monikers)
        // Does this URL arrangement support monikers?
        if ($url_id !== null && $redirect_if_non_canonical) { // NB: Comcode page monikers would have been handled in the code above
            $type = get_param('type', 'browse');
            $looking_for = '_SEARCH:' . $page . ':' . $type . ':_WILD';
            $hooks = find_all_hooks('systems', 'content_meta_aware');
            $ob_info = null;
            foreach (array_keys($hooks) as $hook) {
                require_code('content');
                $ob = get_content_object($hook);
                if ($ob === null) {
                    continue;
                }
                $ob_info = $ob->info();
                $ob_info['view_page_link_pattern'] = preg_replace('#:[^:]*$#', ':_WILD', $ob_info['view_page_link_pattern']);

                if (($ob_info['view_page_link_pattern'] == $looking_for) && ($ob_info['support_url_monikers'])) {
                    if (is_numeric($url_id)) { // Lookup and redirect to moniker
                        $correct_moniker = find_id_moniker(array('page' => $page, 'type' => get_param('type', 'browse'), 'id' => $url_id), $zone);
                        if (($correct_moniker !== null) && ($correct_moniker != $url_id) && (count($_POST) == 0)) { // test is very unlikely to fail. Will only fail if the title of the resource was numeric - in which case the moniker was chosen to be the ID (NOT the number in the title, as that would have created ambiguity).
                            header('HTTP/1.0 301 Moved Permanently');
                            $_new_url = build_url(array('page' => '_SELF', 'id' => $correct_moniker), '_SELF', null, true);
                            $new_url = $_new_url->evaluate();
                            header('Location: ' . $new_url);
                            exit();
                        }
                    } else {
                        // See if it is deprecated
                        if (strpos(get_db_type(), 'mysql') !== false) {
                            $monikers = $GLOBALS['SITE_DB']->query_select('url_id_monikers USE INDEX (uim_moniker)', array('m_resource_id', 'm_deprecated'), array('m_resource_page' => $page, 'm_resource_type' => get_param('type', 'browse'), 'm_moniker' => $url_id));
                        } else {
                            $monikers = $GLOBALS['SITE_DB']->query_select('url_id_monikers', array('m_resource_id', 'm_deprecated'), array('m_resource_page' => $page, 'm_resource_type' => get_param('type', 'browse'), 'm_moniker' => $url_id));
                        }
                        if (!array_key_exists(0, $monikers)) { // hmm, deleted?
                            warn_exit(do_lang_tempcode('MISSING_RESOURCE'));
                        }

                        // Map back 'id'
                        $_GET['id'] = $monikers[0]['m_resource_id']; // We need to know the ID number rather than the moniker

                        $deprecated = $monikers[0]['m_deprecated'] == 1;
                        if (($deprecated) && (count($_POST) == 0)) {
                            $correct_moniker = find_id_moniker(array('page' => $page, 'type' => get_param('type', 'browse'), 'id' => $monikers[0]['m_resource_id']), $zone);
                            if ($correct_moniker != $url_id) { // Just in case database corruption means ALL are deprecated
                                header('HTTP/1.0 301 Moved Permanently');
                                $_new_url = build_url(array('page' => '_SELF', 'id' => $correct_moniker), '_SELF', null, true);
                                $new_url = $_new_url->evaluate();
                                header('Location: ' . $new_url);
                                exit();
                            }
                        }
                    }
                    return;
                }
            }
        }
    }
}

/**
 * This is it - the start of rendering of a website page.
 * Take in all inputs, sends them to the correct functions to process, gathers up all the outputs, sticks them together and echoes them.
 */
function do_site()
{
    // Any messages to output?
    if (get_param_integer('redirected', 0) == 1) {
        $messages = $GLOBALS['SITE_DB']->query_select('messages_to_render', array('r_message', 'r_type'), array('r_session_id' => get_session_id(),), 'ORDER BY r_time DESC');
        foreach ($messages as $message) {
            if ($GLOBALS['XSS_DETECT']) {
                ocp_mark_as_escaped($message['r_message']);
            }
            attach_message(protect_from_escaping($message['r_message']), $message['r_type']);
        }
        if (count($messages) != 0) {
            $GLOBALS['SITE_DB']->query('DELETE FROM ' . $GLOBALS['SITE_DB']->get_table_prefix() . 'messages_to_render WHERE ' . db_string_equal_to('r_session_id', get_session_id()) . ' OR r_time<' . strval(time() - 60 * 60));
        }
    }

    $out_evaluated = null;
    global $ZONE;

    // Note any special handling needed
    $special_page_type = get_param('special_page_type', 'view');
    $keep_markers = get_param_integer('keep_markers', 0);
    $show_edit_links = get_param_integer('show_edit_links', 0);
    global $KEEP_MARKERS, $SHOW_EDIT_LINKS;
    /** Whether we will be embedding template markers in the output.
     *
     * @sets_output_state
     *
     * @global ?array $KEEP_MARKERS
     */
    $KEEP_MARKERS = ($keep_markers == 1) || ($special_page_type == 'show_markers');
    if (($KEEP_MARKERS) && (!headers_sent())) {
        header('Content-type: text/html; charset=' . get_charset());
    }
    /** Whether we will be embedding edit links in the output.
     *
     * @sets_output_state
     *
     * @global ?array $SHOW_EDIT_LINKS
     */
    $SHOW_EDIT_LINKS = ($show_edit_links == 1) || ($special_page_type == 'show_edit_links');
    if (($special_page_type != 'view') && ($special_page_type != 'show_markers')) {
        require_code('view_modes');
        initialise_special_page_types($special_page_type);
    }
    $doing_special_page_type = ($special_page_type != 'view') && ($special_page_type != 'show_markers') && ($special_page_type != 'show_edit_links') && ($special_page_type != 'memory') && ((has_privilege(get_member(), 'view_profiling_modes')) || ($GLOBALS['IS_ACTUALLY_ADMIN']));

    // Allow the site to be closed
    $site_closed = get_option('site_closed');
    if (($site_closed == '1') && (!has_privilege(get_member(), 'access_closed_site')) && (!$GLOBALS['IS_ACTUALLY_ADMIN'])) {
        require_code('site2');
        closed_site();
    }

    // Warning about whether the Setup Wizard still needs running
    $zone = get_zone_name();
    if (($zone == 'adminzone') || ($zone == 'cms')) {
        if ((get_param_integer('cancel_sw_warn', 0) == 1) || (!addon_installed('setupwizard'))) {
            set_value('setupwizard_completed', '1');
        } else {
            $_done_sw_once = get_value('setupwizard_completed');
            $done_sw_once = !is_null($_done_sw_once);
            if ((!$done_sw_once) && (get_param('page', '') != 'admin_setupwizard') && (has_actual_page_access(get_member(), 'admin_setupwizard'))) {
                require_lang('config');
                $setupwizard_url = build_url(array('page' => 'admin_setupwizard'), get_module_zone('admin_setupwizard'));
                $cancel_sw_url = get_self_url(false, false, array('cancel_sw_warn' => 1));
                attach_message(do_lang_tempcode('SETUPWIZARD_NOT_RUN', escape_html($setupwizard_url->evaluate()), escape_html($cancel_sw_url->evaluate())), 'notice');
            }
        }
    }

    // Output streaming?
    $out = globalise(null, null, '', true);

    // Load up our frames into strings. Note that the header and the footer are fixed already.
    $middle = request_page(get_page_name(), true, null, null, false, false, $out);
    if (($middle === null) || ($middle->is_empty_shell())) {
        set_http_status_code('404');

        $title = get_screen_title('ERROR_OCCURRED');
        $text = do_lang_tempcode('NO_PAGE_OUTPUT');
        $middle = warn_screen($title, $text, false);
    }
    $out->singular_bind('MIDDLE', $middle);

    // Validation
    $novalidate = get_param_integer('keep_novalidate', get_param_integer('novalidate', 0));
    $show_edit_links = get_param_integer('show_edit_links', 0);
    if ((($GLOBALS['IS_ACTUALLY_ADMIN']) || ($GLOBALS['FORUM_DRIVER']->is_staff(get_member()))) && (($special_page_type == 'code') || (($novalidate == 0) && (get_option('validation') == '1'))) && ($GLOBALS['REFRESH_URL'][0] == '') && ($show_edit_links == 0)) { // Not a permission - a matter of performance
        require_code('view_modes');
        $out_evaluated = $out->evaluate(null);
        do_xhtml_validation($out_evaluated, ($special_page_type == 'code' && (get_param_integer('preview_mode', null) === null)), get_param_integer('preview_mode', 0));
    }

    // Cacheing for spiders
    if ((running_script('index')) && (count($_POST) == 0) && (isset($GLOBALS['SITE_INFO']['fast_spider_cache'])) && ($GLOBALS['SITE_INFO']['fast_spider_cache'] != '0') && (is_guest())) {
        $bot_type = get_bot_type();
        if ((($bot_type !== null) || ((isset($GLOBALS['SITE_INFO']['any_guest_cached_too'])) && ($GLOBALS['SITE_INFO']['any_guest_cached_too'] == '1'))) && (can_fast_spider_cache())) {
            $fast_cache_path = get_custom_file_base() . '/caches/guest_pages/' . md5(serialize(get_self_url_easy()));
            if ($bot_type === null) {
                $fast_cache_path .= '__non-bot';
            }
            if (!array_key_exists('js_on', $_COOKIE)) {
                $fast_cache_path .= '__no-js';
            }
            if (is_mobile()) {
                $fast_cache_path .= '_mobile';
            }
            $fast_cache_path .= '.gcd';

            if (!is_dir(get_custom_file_base() . '/caches/guest_pages/')) {
                require_code('files2');
                make_missing_directory(get_custom_file_base() . '/caches/guest_pages');
            }

            $out_evaluated = $out->evaluate(null);

            $myfile = @fopen($fast_cache_path, GOOGLE_APPENGINE ? 'wb' : 'ab') or intelligent_write_error($fast_cache_path);
            @flock($myfile, LOCK_EX);
            if (!GOOGLE_APPENGINE) {
                ftruncate($myfile, 0);
            }
            if (function_exists('gzencode')) {
                fwrite($myfile, gzencode($out_evaluated, 9));
            } else {
                fwrite($myfile, $out_evaluated);
            }
            @flock($myfile, LOCK_UN);
            fclose($myfile);
            fix_permissions($fast_cache_path);
            sync_file($fast_cache_path);
        }
    }

    // Something to do now rather than output normal screen?
    if ($doing_special_page_type) {
        special_page_types($special_page_type, $out, $out_evaluated);
    }
    if ((in_safe_mode()) && (!isset($GLOBALS['SITE_INFO']['safe_mode']))) {
        $disable_safe_mode_url = get_self_url(true, true, array('keep_safe_mode' => null));
        attach_message(do_lang_tempcode('CURRENTLY_HAS_KEEP_SAFE_MODE', escape_html($disable_safe_mode_url)), 'notice');
    }
    if (get_param_integer('keep_fatalistic', 0) == 1) {
        $disable_fatalistic_url = get_self_url(true, true, array('keep_fatalistic' => null));
        attach_message(do_lang_tempcode('CURRENTLY_HAS_KEEP_FATALISTIC', escape_html($disable_fatalistic_url)), 'notice');
    }

    // We calculated the time before outputting so that latency and bandwidth do not adversely affect the result
    global $PAGE_START_TIME, $PAGE_STRING;
    $page_generation_time = (microtime(true) - $PAGE_START_TIME) * 1000.0;

    // Output
    if (!$GLOBALS['QUICK_REDIRECT']) {
        if ($out_evaluated !== null) {
            echo $out_evaluated;
        } else {
            $GLOBALS['FINISHING_OUTPUT'] = true;
            /*if (get_option('gzip_output')=='1')  Does not work well
                    ob_start('_compress_html_output');*/
            $out->evaluate_echo(null);
        }
    }

    // Finally, stats
    if ($PAGE_STRING !== null) {
        log_stats($PAGE_STRING, intval($page_generation_time));
    }

    // When someone hits the Admin Zone front page.
    if (($ZONE['zone_name'] == 'adminzone') && (get_page_name() == 'start')) {
        // Security feature admins can turn on
        require_code('notifications');
        $current_username = $GLOBALS['FORUM_DRIVER']->get_username(get_member());
        $subject = do_lang('AFA_NOTIFICATION_MAIL_SUBJECT', $current_username, get_site_name(), get_ip_address());
        $mail = do_lang('AFA_NOTIFICATION_MAIL', comcode_escape(get_site_name()), comcode_escape($current_username), comcode_escape(get_ip_address()));

        dispatch_notification('adminzone_dashboard_accessed', null, $subject, $mail);

        // Track very basic details of what sites use ocPortal. You can remove if you like.
        if ((!running_locally()) && (get_option('call_home') == '1')) {
            $timeout_before = @ini_get('default_socket_timeout');
            @ini_set('default_socket_timeout', '3');
            require_code('version2');
            http_download_file('http://ocportal.com/uploads/website_specific/ocportal.com/scripts/user.php?url=' . urlencode(get_base_url()) . '&name=' . urlencode(get_site_name()) . '&version=' . urlencode(get_version_dotted()), null, false);
            @ini_set('default_socket_timeout', $timeout_before);
        }
    }

    // Little disk space check
    $last_space_check = get_value('last_space_check');
    if (($last_space_check === null) || (intval($last_space_check) < time() - 60 * 60 * 3)) {
        if (!$GLOBALS['SITE_DB']->table_is_locked('values')) {
            set_value('last_space_check', strval(time()));
        }

        if (function_exists('disk_free_space')) {
            $low_space_check = intval(get_option('low_space_check')) * 1024 * 1024;
            $disk_space = @disk_free_space(get_file_base());
            if ((is_integer($disk_space)) && ($disk_space < $low_space_check)) {
                require_code('notifications');
                $subject = do_lang('LOW_DISK_SPACE_SUBJECT', null, null, null, get_site_default_lang());
                $message = do_lang('LOW_DISK_SPACE_MAIL', strval(intval(round($disk_space / 1024 / 1024))), null, null, get_site_default_lang());
                dispatch_notification('low_disk_space', null, $subject, $message, null, A_FROM_SYSTEM_PRIVILEGED);
            }
        }
    }
}

/**
 * Take the specified parameters, and try to find the corresponding page, then execute a function to load the page (load_html_page/load_comcode_page).
 *
 * @param  ID_TEXT                      $codename The codename of the page to load
 * @param  boolean                      $required Whether it is required for this page to exist (shows an error if it doesn't) -- otherwise, it will just return NULL
 * @param  ?ID_TEXT                     $zone The zone the page is being loaded in (null: as shown by access URL)
 * @param  ?ID_TEXT                     $page_type The type of page - for if you know it (null: don't know it)
 * @param  boolean                      $being_included Whether the page is being included from another
 * @param  boolean                      $no_redirect_check Whether to not check for redirects (normally you would)
 * @param  ?object                      $out Semi-filled output template (null: definitely not doing output streaming)
 * @return ?tempcode                    The page (null: no page)
 */
function request_page($codename, $required, $zone = null, $page_type = null, $being_included = false, $no_redirect_check = false, &$out = null)
{
    global $SITE_INFO;

    if ($zone === null) {
        $zone = get_zone_name();
    }

    if (($zone == 'site') && (get_option('collapse_user_zones') == '1')) {
        $zone = ''; // Might have been explicitly said in Tempcode, for example
    }

    $details = _request_page($codename, $zone, $page_type, null, $no_redirect_check);

    global $REQUEST_PAGE_NEST_LEVEL;
    $REQUEST_PAGE_NEST_LEVEL++;
    if ($REQUEST_PAGE_NEST_LEVEL > 20) {
        $REQUEST_PAGE_NEST_LEVEL = 0;
        attach_message(do_lang_tempcode('STOPPED_RECURSIVE_RESOURCE_INCLUDE', $codename), 'warn');
        return null;
    }

    // Run hooks, if any exist
    $hooks = find_all_hooks('systems', 'upon_page_load');
    foreach (array_keys($hooks) as $hook) {
        require_code('hooks/systems/upon_page_load/' . filter_naughty($hook));
        $ob = object_factory('upon_page_load' . filter_naughty($hook), true);
        if ($ob === null) {
            continue;
        }
        $ob->run($codename, $required, $zone, $page_type, $being_included, $details);
    }

    if ($details === false) {
        if ($required) {
            if (get_option('url_scheme') == 'SIMPLE') {
                $details = _request_page('404', '', null, null, false);
            }
        }

        if ($details === false) {
            if ($required) {
                require_code('site2');
                $ret = page_not_found($codename, $zone);
                $REQUEST_PAGE_NEST_LEVEL--;
                return $ret;
            }
            $REQUEST_PAGE_NEST_LEVEL--;
            return new Tempcode();
        }
    }

    switch ($details[0]) {
        case 'MODULES_CUSTOM':
            $path = isset($details[3]) ? $details[3] : zone_black_magic_filterer($details[1] . (($details[1] == '') ? '' : '/') . 'pages/modules_custom/' . $details[2] . '.php', true);
            $ret = load_module_page($path, $details[2], $out);
            $REQUEST_PAGE_NEST_LEVEL--;
            return $ret;
        case 'MODULES':
            $path = isset($details[3]) ? $details[3] : zone_black_magic_filterer($details[1] . (($details[1] == '') ? '' : '/') . 'pages/modules/' . $details[2] . '.php', true);
            $ret = load_module_page($path, $details[2], $out);
            $REQUEST_PAGE_NEST_LEVEL--;
            return $ret;
        case 'COMCODE_CUSTOM':
            $path = isset($details[4]) ? $details[4] : zone_black_magic_filterer($details[1] . (($details[1] == '') ? '' : '/') . 'pages/comcode_custom/' . $details[3] . '/' . $details[2] . '.txt', true);
            if (((isset($SITE_INFO['no_disk_sanity_checks'])) && ($SITE_INFO['no_disk_sanity_checks'] == '1') && (get_custom_file_base() == get_file_base())) || (is_file(get_custom_file_base() . '/' . $path))) {
                $ret = load_comcode_page($path, $details[1], $details[2], get_custom_file_base(), $being_included, $out);
                $REQUEST_PAGE_NEST_LEVEL--;
                return $ret;
            }
        // else roll on, as probably been deleted since persistent cache was filled
        case 'COMCODE_CUSTOM_PURE':
            $path = isset($details[4]) ? $details[4] : zone_black_magic_filterer($details[1] . (($details[1] == '') ? '' : '/') . 'pages/comcode_custom/' . $details[3] . '/' . $details[2] . '.txt', true);
            if (((isset($SITE_INFO['no_disk_sanity_checks'])) && ($SITE_INFO['no_disk_sanity_checks'] == '1')) || (is_file(get_file_base() . '/' . $path))) {
                $ret = load_comcode_page($path, $details[1], $details[2], get_file_base(), $being_included, $out);
                $REQUEST_PAGE_NEST_LEVEL--;
                return $ret;
            }
        // else roll on, as probably been deleted since persistent cache was filled
        case 'COMCODE':
            $path = isset($details[4]) ? $details[4] : zone_black_magic_filterer($details[1] . (($details[1] == '') ? '' : '/') . 'pages/comcode/' . $details[3] . '/' . $details[2] . '.txt', true);
            if (((isset($SITE_INFO['no_disk_sanity_checks'])) && ($SITE_INFO['no_disk_sanity_checks'] == '1')) || (is_file(get_file_base() . '/' . $path))) {
                $ret = load_comcode_page($path, $details[1], $details[2], null, $being_included, $out);
                $REQUEST_PAGE_NEST_LEVEL--;
                return $ret;
            }
        // else roll on, as probably been deleted since persistent cache was filled
        case 'HTML_CUSTOM':
            require_code('site_html_pages');
            $path = isset($details[4]) ? $details[4] : zone_black_magic_filterer($details[1] . (($details[1] == '') ? '' : '/') . 'pages/html_custom/' . $details[3] . '/' . $details[2] . '.htm', true);
            $ret = make_string_tempcode(load_html_page($path, null, $out));
            $REQUEST_PAGE_NEST_LEVEL--;
            return $ret;
        case 'HTML':
            require_code('site_html_pages');
            $path = isset($details[4]) ? $details[4] : zone_black_magic_filterer($details[1] . (($details[1] == '') ? '' : '/') . 'pages/html/' . $details[3] . '/' . $details[2] . '.htm', true);
            $ret = make_string_tempcode(load_html_page($path, null, $out));
            $REQUEST_PAGE_NEST_LEVEL--;
            return $ret;
        case 'MINIMODULES_CUSTOM':
            $path = isset($details[3]) ? $details[3] : zone_black_magic_filterer($details[1] . (($details[1] == '') ? '' : '/') . 'pages/minimodules_custom/' . $codename . '.php', true);
            $ret = load_minimodule_page($path, $out);
            $REQUEST_PAGE_NEST_LEVEL--;
            return $ret;
        case 'MINIMODULES':
            $path = isset($details[3]) ? $details[3] : zone_black_magic_filterer($details[1] . (($details[1] == '') ? '' : '/') . 'pages/minimodules/' . $codename . '.php', true);
            $ret = load_minimodule_page($path, $out);
            $REQUEST_PAGE_NEST_LEVEL--;
            return $ret;
        case 'REDIRECT':
            $redirect = $details[1];
            if ($required) {
                global $REDIRECTED_TO_CACHE;
                $REDIRECTED_TO_CACHE = $redirect;
            }
            if (strpos($redirect['r_to_page'], ':') !== false) {
                $bits = page_link_decode($redirect['r_to_zone'] . ':' . $redirect['r_to_page']);
            } else {
                $bits = array($redirect['r_to_zone'], array('page' => $redirect['r_to_page']));
            }
            // Transparent redirection?
            if ($redirect['r_is_transparent'] == 1) {
                if (($being_included) && (!has_page_access(get_member(), $redirect['r_to_page'], $redirect['r_to_zone'], true))) {
                    access_denied('PAGE_ACCESS');
                }

                foreach ($bits[1] as $key => $val) {
                    if ($key != 'page') {
                        $_GET[$key] = get_magic_quotes_gpc() ? addslashes($val) : $val;
                    }
                }
                if (($redirect['r_to_page'] != $codename) || ($redirect['r_to_zone'] != $zone)) {
                    $ret = request_page($redirect['r_to_page'], $required, $redirect['r_to_zone'], null, $being_included, $redirect['r_is_transparent'] == 1, $out);
                    $REQUEST_PAGE_NEST_LEVEL--;
                    return $ret;
                }
            } else {
                $title = get_screen_title('REDIRECTING');
                $url = build_url($bits[1], $redirect['r_to_zone'], null, true);
                header('HTTP/1.1 301 Moved Permanently');
                $ret = redirect_screen($title, $url, do_lang_tempcode('REDIRECTED_LINK'), true);
                $REQUEST_PAGE_NEST_LEVEL--;
                return $ret;
            }
    }

    $REQUEST_PAGE_NEST_LEVEL--;
    return new Tempcode(); // should never get here
}

/**
 * Take the specified parameters, and try to find the corresponding page (caching front end).
 *
 * @param  ID_TEXT                      $codename The codename of the page to load
 * @param  ID_TEXT                      $zone The zone the page is being loaded in
 * @param  ?ID_TEXT                     $page_type The type of page - for if you know it (null: don't know it)
 * @param  ?LANGUAGE_NAME               $lang Language name (null: users language)
 * @param  boolean                      $no_redirect_check Whether to not check for redirects (normally you would)
 * @return ~array                       A list of details (false: page not found)
 */
function _request_page($codename, $zone, $page_type = null, $lang = null, $no_redirect_check = false)
{
    $details = persistent_cache_get(array('PAGE_INFO', $codename, $zone, $page_type, $lang, $no_redirect_check));
    if ($details === null) {
        $details = __request_page($codename, $zone, $page_type, null, $no_redirect_check);
        persistent_cache_set(array('PAGE_INFO', $codename, $zone, $page_type, $lang, $no_redirect_check), $details);
    }
    return $details;
}

/**
 * Take the specified parameters, and try to find the corresponding page.
 *
 * @param  ID_TEXT                      $codename The codename of the page to load
 * @param  ID_TEXT                      $zone The zone the page is being loaded in
 * @param  ?ID_TEXT                     $page_type The type of page - for if you know it (null: don't know it)
 * @param  ?LANGUAGE_NAME               $lang Language name (null: users language)
 * @param  boolean                      $no_redirect_check Whether to not check for redirects (normally you would)
 * @return ~array                       A list of details (false: page not found)
 */
function __request_page($codename, $zone, $page_type = null, $lang = null, $no_redirect_check = false)
{
    if ($lang === null) {
        $lang = user_lang();
    }

    if ($codename == 'login') { // Special case
        $login_zone = get_module_zone('login');
        $path = zone_black_magic_filterer($login_zone . (($login_zone == '') ? '' : '/') . 'pages/modules_custom/' . $codename . '.php', true);
        if (is_file(get_file_base() . '/' . $path)) {
            return array('MODULES_CUSTOM', $login_zone, $codename, $path);
        }
        $path = zone_black_magic_filterer($login_zone . (($login_zone == '') ? '' : '/') . 'pages/modules/' . $codename . '.php', true);
        if (is_file(get_file_base() . '/' . $path)) {
            return array('MODULES', $login_zone, $codename, $path);
        }
    }

    // Redirect
    if ((!$no_redirect_check) && (get_value('no_priority_redirects') !== '1') && (addon_installed('redirects_editor'))) {
        $test = _request_page__redirects($codename, $zone);
        if ($test !== false) {
            return $test;
        }
    }

    // If we know the page type
    if ($page_type !== null) {
        switch ($page_type) {
            case 'modules_custom':
                if (!in_safe_mode()) {
                    $path = zone_black_magic_filterer($zone . (($zone == '') ? '' : '/') . 'pages/modules_custom/' . $codename . '.php', true);
                    if (is_file(get_file_base() . '/' . $path)) {
                        return array('MODULES_CUSTOM', $zone, $codename, $path);
                    }
                }
                break;
            case 'modules':
                $path = zone_black_magic_filterer($zone . (($zone == '') ? '' : '/') . 'pages/modules/' . $codename . '.php', true);
                if (is_file(get_file_base() . '/' . $path)) {
                    return array('MODULES', $zone, $codename, $path);
                }
                break;
            case 'comcode_custom':
                if (!in_safe_mode()) {
                    if (get_param_integer('keep_theme_test', 0) == 1) {
                        $path = zone_black_magic_filterer($zone . (($zone == '') ? '' : '/') . 'pages/comcode_custom/' . $lang . '/' . $GLOBALS['FORUM_DRIVER']->get_theme() . '__' . $codename . '.txt', true);
                        if (is_file(get_custom_file_base() . '/' . $path)) {
                            return array('COMCODE_CUSTOM', $zone, $GLOBALS['FORUM_DRIVER']->get_theme() . '__' . $codename, $lang, $path);
                        }
                    }

                    $path = zone_black_magic_filterer($zone . (($zone == '') ? '' : '/') . 'pages/comcode_custom/' . $lang . '/' . $codename . '.txt', true);
                    if (is_file(get_custom_file_base() . '/' . $path)) {
                        return array('COMCODE_CUSTOM', $zone, $codename, $lang, $path);
                    }
                    if (get_custom_file_base() != get_file_base()) { // For multisite installs we also will search the root site's Custom Comcode pages
                        $path = zone_black_magic_filterer($zone . (($zone == '') ? '' : '/') . 'pages/comcode_custom/' . $lang . '/' . $codename . '.txt', true);
                        if (is_file(get_file_base() . '/' . $path)) {
                            return array('COMCODE_CUSTOM_PURE', $zone, $codename, $lang, $path);
                        }
                    }
                }
            //break;
            case 'comcode':
                $path = zone_black_magic_filterer($zone . (($zone == '') ? '' : '/') . 'pages/comcode/' . $lang . '/' . $codename . '.txt', true);
                if (is_file(get_file_base() . '/' . $path)) {
                    return array('COMCODE', $zone, $codename, $lang, $path);
                }
                break;
            case 'html_custom':
                if (!in_safe_mode()) {
                    $path = zone_black_magic_filterer($zone . (($zone == '') ? '' : '/') . 'pages/html_custom/' . $lang . '/' . $codename . '.htm', true);
                    if (is_file(get_custom_file_base() . '/' . $path)) {
                        return array('HTML_CUSTOM', $zone, $codename, $lang, $path);
                    }
                }
                break;
            case 'html':
                $path = zone_black_magic_filterer($zone . (($zone == '') ? '' : '/') . 'pages/html/' . $lang . '/' . $codename . '.htm', true);
                if (is_file(get_file_base() . '/' . $path)) {
                    return array('HTML', $zone, $codename, $lang, $path);
                }
                break;
            case 'minimodules_custom':
                if (!in_safe_mode()) {
                    $path = zone_black_magic_filterer($zone . (($zone == '') ? '' : '/') . 'pages/minimodules_custom/' . $lang . '/' . $codename . '.php', true);
                    if (is_file(get_file_base() . '/' . $path)) {
                        return array('MINIMODULES_CUSTOM', $zone, $codename, $path);
                    }
                }
                break;
            case 'minimodules':
                $path = zone_black_magic_filterer($zone . (($zone == '') ? '' : '/') . 'pages/minimodules/' . $lang . '/' . $codename . '.php', true);
                if (is_file(get_file_base() . '/' . $path)) {
                    return array('MINIMODULES', $zone, $codename, $path);
                }
                break;
        }

        return false;
    }

    // We have a priority list to find our page
    if (!in_safe_mode()) {
        $path = zone_black_magic_filterer($zone . (($zone == '') ? '' : '/') . 'pages/minimodules_custom/' . $codename . '.php', true);
        if (is_file(get_file_base() . '/' . $path)) {
            return array('MINIMODULES_CUSTOM', $zone, $codename, $path);
        }
    }
    if (!in_safe_mode()) {
        $path = zone_black_magic_filterer($zone . (($zone == '') ? '' : '/') . 'pages/modules_custom/' . $codename . '.php', true);
        if (is_file(get_file_base() . '/' . $path)) {
            return array('MODULES_CUSTOM', $zone, $codename, $path);
        }
    }
    $path = zone_black_magic_filterer($zone . (($zone == '') ? '' : '/') . 'pages/modules/' . $codename . '.php', true);
    if (is_file(get_file_base() . '/' . $path)) {
        return array('MODULES', $zone, $codename, $path);
    }
    if (!in_safe_mode()) {
        if (get_param_integer('keep_theme_test', 0) == 1) {
            $path = zone_black_magic_filterer($zone . (($zone == '') ? '' : '/') . 'pages/comcode_custom/' . $lang . '/' . $GLOBALS['FORUM_DRIVER']->get_theme() . '__' . $codename . '.txt', true);
            if (is_file(get_custom_file_base() . '/' . $path)) {
                return array('COMCODE_CUSTOM', $zone, $GLOBALS['FORUM_DRIVER']->get_theme() . '__' . $codename, $lang, $path);
            }
        }

        $path = zone_black_magic_filterer($zone . (($zone == '') ? '' : '/') . 'pages/comcode_custom/' . $lang . '/' . $codename . '.txt', true);
        if (is_file(get_custom_file_base() . '/' . $path)) {
            return array('COMCODE_CUSTOM', $zone, $codename, $lang, $path);
        }
        if (get_custom_file_base() != get_file_base()) { // For multisite installs we also will search the root site's Custom Comcode pages
            $path = zone_black_magic_filterer($zone . (($zone == '') ? '' : '/') . 'pages/comcode_custom/' . $lang . '/' . $codename . '.txt', true);
            if (is_file(get_file_base() . '/' . $path)) {
                return array('COMCODE_CUSTOM_PURE', $zone, $codename, $lang, $path);
            }
        }
    }
    $path = zone_black_magic_filterer($zone . (($zone == '') ? '' : '/') . 'pages/comcode/' . $lang . '/' . $codename . '.txt', true);
    if (is_file(get_file_base() . '/' . $path)) {
        return array('COMCODE', $zone, $codename, $lang, $path);
    }
    if (!in_safe_mode()) {
        $path = zone_black_magic_filterer($zone . (($zone == '') ? '' : '/') . 'pages/html_custom/' . $lang . '/' . $codename . '.htm', true);
        if (is_file(get_custom_file_base() . '/' . $path)) {
            return array('HTML_CUSTOM', $zone, $codename, $lang, $path);
        }
    }
    $path = zone_black_magic_filterer($zone . (($zone == '') ? '' : '/') . 'pages/html/' . $lang . '/' . $codename . '.htm', true);
    if (is_file(get_file_base() . '/' . $path)) {
        return array('HTML', $zone, $codename, $lang, $path);
    }
    $path = zone_black_magic_filterer($zone . (($zone == '') ? '' : '/') . 'pages/minimodules/' . $codename . '.php', true);
    if (is_file(get_file_base() . '/' . $path)) {
        return array('MINIMODULES', $zone, $codename, $path);
    }

    // As a last resort, consider it might not yet have been translated
    $fallback_lang = fallback_lang();
    $site_lang = get_site_default_lang();
    $langs_to_try = array();
    if ($lang != $site_lang) {
        $langs_to_try[] = $site_lang;
    }
    if ($lang != $fallback_lang) {
        $langs_to_try[] = $fallback_lang;
    }
    foreach ($langs_to_try as $fallback_lang) {
        if (!in_safe_mode()) {
            $path = zone_black_magic_filterer($zone . (($zone == '') ? '' : '/') . 'pages/comcode_custom/' . $fallback_lang . '/' . $codename . '.txt', true);
            if (is_file(get_custom_file_base() . '/' . $path)) {
                return array('COMCODE_CUSTOM', $zone, $codename, $fallback_lang, $path);
            }
            if (get_custom_file_base() != get_file_base()) { // For multisite installs we also will search the root site's Custom Comcode pages
                $path = zone_black_magic_filterer($zone . (($zone == '') ? '' : '/') . 'pages/comcode_custom/' . $fallback_lang . '/' . $codename . '.txt', true);
                if (is_file(get_file_base() . '/' . $path)) {
                    return array('COMCODE_CUSTOM_PURE', $zone, $codename, $fallback_lang, $path);
                }
            }
        }
        $path = zone_black_magic_filterer($zone . (($zone == '') ? '' : '/') . 'pages/comcode/' . $fallback_lang . '/' . $codename . '.txt', true);
        if (is_file(get_file_base() . '/' . $path)) {
            return array('COMCODE', $zone, $codename, $fallback_lang, $path);
        }
        if (!in_safe_mode()) {
            $path = zone_black_magic_filterer($zone . (($zone == '') ? '' : '/') . 'pages/html_custom/' . $fallback_lang . '/' . $codename . '.htm', true);
            if (is_file(get_custom_file_base() . '/' . $path)) {
                return array('HTML_CUSTOM', $zone, $codename, $fallback_lang, $path);
            }
        }
        $path = zone_black_magic_filterer($zone . (($zone == '') ? '' : '/') . 'pages/html/' . $fallback_lang . '/' . $codename . '.htm', true);
        if (is_file(get_file_base() . '/' . $path)) {
            return array('HTML', $zone, $codename, $fallback_lang, $path);
        }
    }

    // Redirect
    if ((!$no_redirect_check) && (addon_installed('redirects_editor'))) {
        $test = _request_page__redirects($codename, $zone, true/*include wildcards as this is lowest priority*/);
        if ($test !== false) {
            return $test;
        }
    }

    return false;
}

/**
 * Take the specified parameters, and try to find a redirect for the corresponding page
 *
 * @param  ID_TEXT                      $codename The codename of the page to load
 * @param  ID_TEXT                      $zone The zone the page is being loaded in
 * @param  boolean                      $wildcard_mode Whether to also search in wildcard mode
 * @return ~array                       A list of details (false: page not found)
 */
function _request_page__redirects($codename, $zone, $wildcard_mode = false)
{
    global $REDIRECT_CACHE;
    if ($REDIRECT_CACHE === null) {
        load_redirect_cache();
    }
    if (isset($REDIRECT_CACHE[$zone])) {
        if (isset($REDIRECT_CACHE[$zone][$codename])) {
            $redirect = array($REDIRECT_CACHE[$zone][$codename]);
        } elseif (($wildcard_mode) && (isset($REDIRECT_CACHE['*'][$codename]))) {
            $redirect = array($REDIRECT_CACHE['*'][$codename]);
        } else {
            $redirect = array();
        }
    } else {
        $query = 'SELECT * FROM ' . get_table_prefix() . 'redirects WHERE (' . db_string_equal_to('r_from_zone', '*');
        if ($wildcard_mode) {
            $query .= ' OR ' . db_string_equal_to('r_from_zone', $zone);
        }
        $query .= ') AND ' . db_string_equal_to('r_from_page', $codename);
        $query .= ' ORDER BY r_from_zone DESC'; // The ordering ensures '*' comes last, as we want to deprioritise this
        $redirect = $GLOBALS['SITE_DB']->query($query, 1, null, false, true);
    }
    if (isset($redirect[0])) {
        return array('REDIRECT', $redirect[0]);
    }
    return false;
}

/**
 * Get the parsed contents of a Comcode page.
 *
 * @param  PATH                         $string The relative (to ocPortal's base directory) path to the page (e.g. pages/comcode/EN/start.txt)
 * @param  ID_TEXT                      $zone The zone the page is being loaded from
 * @param  ID_TEXT                      $codename The codename of the page
 * @param  ?PATH                        $file_base The file base to load from (null: standard)
 * @param  boolean                      $being_included Whether the page is being included from another
 * @param  ?object                      $out Semi-filled output template (null: definitely not doing output streaming)
 * @return tempcode                     The page
 */
function load_comcode_page($string, $zone, $codename, $file_base = null, $being_included = false, &$out = null)
{
    if ($file_base === null) {
        $file_base = get_file_base();
    }

    if (!$being_included) {
        $GLOBALS['TITLE_CALLED'] = true;
    }

    $is_panel = (substr($codename, 0, 6) == 'panel_') || ((strpos($codename, 'panel_') !== false) && (get_param_integer('keep_theme_test', 0) == 1));

    if ($zone == '' && $codename == '404') {
        set_http_status_code('404');
    }

    if (
        (
            ($is_panel) ||
            ($codename[0] == '_') ||
            ($zone . ':' . $codename == ':404') ||

            // Sculpt what comes up in Google a bit. We don't want really meta contextual help muddying search results
            ($codename == 'rules') ||
            ($zone . ':' . $codename == ':recommend_help') ||
            ($zone . ':' . $codename == ':popup_blockers') ||
            ($zone . ':' . $codename == ':help') ||
            ($zone . ':' . $codename == ':userguide_chatcode') ||
            ($zone . ':' . $codename == ':userguide_comcode') ||
            ($zone . ':' . $codename == 'site:popup_blockers') ||
            ($zone . ':' . $codename == 'site:help') ||
            ($zone . ':' . $codename == 'site:userguide_chatcode') ||
            ($zone . ':' . $codename == 'site:userguide_comcode')
        ) &&
        (get_page_name() == $codename/*Top-level*/)
    ) {
        attach_to_screen_header('<meta name="robots" content="noindex" />'); // XHTMLXHTML
    }

    if ($zone == 'adminzone') {
        require_code('site_adminzone');
        adminzone_special_cases($codename);
    }

    if ($codename == 'sitemap') {
        set_feed_url('?mode=comcode_pages&filter=' . $zone);
    }

    global $PAGE_STRING, $COMCODE_PARSE_TITLE, $LAST_COMCODE_PARSED_TITLE;
    $COMCODE_PARSE_TITLE = null;
    if ($PAGE_STRING === null && !$being_included && !$is_panel) {
        $PAGE_STRING = $string;
    }

    $new_comcode_page_row = array(
        'the_zone' => $zone,
        'the_page' => $codename,
        'p_parent_page' => '',
        'p_validated' => 1,
        'p_edit_date' => null,
        'p_add_date' => null,
        'p_submitter' => null,
        'p_show_as_edit' => 0
    );

    if (((get_option('is_on_comcode_page_cache') == '1') || (get_param_integer('keep_cache', 0) == 1) || (get_param_integer('cache', 0) == 1)) && (get_param_integer('keep_cache', null) !== 0) && (get_param_integer('cache', null) !== 0) && (get_param_integer('keep_print', 0) == 0)) {
        global $SITE_INFO;
        $support_smart_decaching = (!isset($SITE_INFO['disable_smart_decaching'])) || ($SITE_INFO['disable_smart_decaching'] != '1');

        if (is_browser_decacheing()) {
            $comcode_page = $GLOBALS['SITE_DB']->query_select('cached_comcode_pages', array('string_index', 'cc_page_title'), array('the_page' => $codename, 'the_zone' => $zone, 'the_theme' => $GLOBALS['FORUM_DRIVER']->get_theme()), '', 1, 0, false, array());
            if (array_key_exists(0, $comcode_page)) {
                if ($comcode_page[0]['string_index'] !== null) {
                    delete_lang($comcode_page[0]['string_index']);
                }
                $GLOBALS['SITE_DB']->query_delete('cached_comcode_pages', array('the_page' => $codename, 'the_zone' => $zone));
            }
        }
        $theme = $GLOBALS['FORUM_DRIVER']->get_theme();
        if ($GLOBALS['PERSISTENT_CACHE'] !== null) {
            if ($support_smart_decaching) {
                $mtime = filemtime($file_base . '/' . $string);
                if ($mtime > time()) {
                    $mtime = time(); // Timezone error, we have to assume that cache is ok rather than letting us get in a loop decacheing the file. It'll get fixed automatically in a few hours when the hours of the timezone difference passes.
                }
                $pcache = persistent_cache_get(array('COMCODE_PAGE', $codename, $zone, $theme, user_lang()), $mtime);
            } else {
                $pcache = persistent_cache_get(array('COMCODE_PAGE', $codename, $zone, $theme, user_lang()));
            }
        } else {
            $pcache = null;
        }
        if ($pcache === null) {
            $comcode_page = $GLOBALS['SITE_DB']->query_select('cached_comcode_pages a JOIN ' . $GLOBALS['SITE_DB']->get_table_prefix() . 'comcode_pages b ON (a.the_page=b.the_page AND a.the_zone=b.the_zone)', array('*'), array('a.the_page' => $codename, 'a.the_zone' => $zone, 'the_theme' => $theme), '', 1, null, false, array('string_index' => 'LONG_TRANS__COMCODE', 'cc_page_title' => '?SHORT_TRANS'));
            if (isset($comcode_page[0])) {
                if ($support_smart_decaching) {
                    $mtime = filemtime($file_base . '/' . $string);
                    if ($mtime > time()) {
                        $mtime = time(); // Timezone error, we have to assume that cache is ok rather than letting us get in a loop decacheing the file. It'll get fixed automatically in a few hours when the hours of the timezone difference passes.
                    }
                }
                if ((!$support_smart_decaching) || ((($comcode_page[0]['p_edit_date'] !== null) && ($comcode_page[0]['p_edit_date'] >= $mtime)) || (($comcode_page[0]['p_edit_date'] === null) && ($comcode_page[0]['p_add_date'] !== null) && ($comcode_page[0]['p_add_date'] >= $mtime)))) { // Make sure it has not been edited since last edited or created
                    $comcode_page_row = $comcode_page[0];
                    $just_comcode_page_row = db_map_restrict($comcode_page_row, array('the_page', 'the_zone', 'the_theme', 'string_index'));
                    $db_set = get_translated_tempcode('cached_comcode_pages', $just_comcode_page_row, 'string_index', null, user_lang(), true, true/*,true*/);
                } else {
                    $mtime = filemtime($file_base . '/' . $string);
                    if ($mtime > time()) {
                        $mtime = time(); // Timezone error, we have to assume that cache is ok rather than letting us get in a loop decacheing the file. It'll get fixed automatically in a few hours when the hours of the timezone difference passes.
                    }
                    $GLOBALS['SITE_DB']->query_update('comcode_pages', array('p_edit_date' => $mtime), array('the_page' => $codename, 'the_zone' => $zone), '', 1);
                    $GLOBALS['SITE_DB']->query_delete('cached_comcode_pages', array('the_zone' => $zone, 'the_page' => $codename));
                    delete_lang($comcode_page[0]['string_index']);

                    $db_set = null;
                    $comcode_page_row = null;
                }
            } else {
                $db_set = null;
                $comcode_page_row = null;
            }
            if ($db_set !== null) {
                $index = $comcode_page[0]['string_index'];
                $title_to_use = $comcode_page[0]['cc_page_title'];
                if ($title_to_use !== null) {
                    $title_to_use = get_translated_text($title_to_use, null, null, true);
                    if ($title_to_use === null) {
                        $title_to_use = $codename;
                    }
                }
                $html = $db_set;
                $raw_comcode = get_translated_text($comcode_page[0]['string_index']);
            } else {
                $comcode_page = $GLOBALS['SITE_DB']->query_select('comcode_pages', array('*'), array('the_page' => $codename, 'the_zone' => $zone), '', 1);
                if (isset($comcode_page[0])) {
                    $comcode_page_row = $comcode_page[0];
                }

                require_code('site2');
                $new_comcode_page_row['p_add_date'] = filectime($file_base . '/' . $string);
                list($html, $title_to_use, $comcode_page_row, $raw_comcode) = _load_comcode_page_not_cached($string, $zone, $codename, $file_base, $comcode_page_row, $new_comcode_page_row, $being_included);
            }

            persistent_cache_set(array('COMCODE_PAGE', $codename, $zone, $theme, user_lang()), array($html, $title_to_use, $comcode_page_row, $raw_comcode));
        } else {
            list($html, $title_to_use, $comcode_page_row, $raw_comcode) = $pcache;
        }
    } else {
        require_code('site2');
        $new_comcode_page_row['p_add_date'] = filectime($file_base . '/' . $string);
        list($html, $comcode_page_row, $title_to_use, $raw_comcode) = _load_comcode_page_cache_off($string, $zone, $codename, $file_base, $new_comcode_page_row, $being_included);
    }
    $filtered_title_to_use = mixed();
    if ((!$is_panel) && (!$being_included)) {
        if (($title_to_use !== null) && ($title_to_use != '')) {
            get_screen_title($title_to_use, false); // Little hack - this will force DISPLAYED_TITLE to get set.
            $filtered_title_to_use = @html_entity_decode(strip_tags($title_to_use), ENT_QUOTES, get_charset());
        }
        seo_meta_load_for('comcode_page', $zone . ':' . $codename, $filtered_title_to_use);
    }
    $LAST_COMCODE_PARSED_TITLE = $title_to_use;

    if (($html->is_empty_shell()) && ($being_included)) {
        return $html;
    }

    if (has_edit_comcode_page_permission($zone, $codename, $comcode_page_row['p_submitter'])) {
        $redirect = get_self_url(true, false, array('redirect' => null, 'redirected' => null));
        if ((($codename == 'panel_left') || ($codename == 'panel_right')) && (has_js()) && (has_actual_page_access(get_member(), 'admin_zones'))) {
            $edit_url = build_url(array('page' => 'admin_zones', 'type' => '_editor', 'id' => get_zone_name(), 'redirect' => $redirect), get_module_zone('admin_zones'));
        } else {
            $edit_url = build_url(array('page' => 'cms_comcode_pages', 'type' => '_edit', 'page_link' => $zone . ':' . $codename,/*'lang'=>user_lang(),*/
                'redirect' => $redirect), get_module_zone('cms_comcode_pages'));
        }
    } else {
        $edit_url = new Tempcode();
    }
    $add_child_url = new Tempcode();
    if (has_add_comcode_page_permission($zone)) {
        if (strpos($raw_comcode, 'main_comcode_page_children') !== false) {
            $add_child_url = (get_option('is_on_comcode_page_children') == '1') ? build_url(array('page' => 'cms_comcode_pages', 'type' => '_edit', 'parent_page' => $codename, 'page_link' => $zone . ':'/*Don't make too many assumptions about user flow ,'lang'=>user_lang()*//*,'redirect'=>$redirect*/), get_module_zone('cms_comcode_pages')) : new Tempcode();
        }
    }

    $warning_details = new Tempcode();
    if (($comcode_page_row['p_validated'] !== null) && ($comcode_page_row['p_validated'] == 0)) {
        require_code('site2');
        $warning_details = get_page_warning_details($zone, $codename, $edit_url);
    }

    if ((!$is_panel) && ($title_to_use !== null) && (!$being_included)) {
        global $PT_PAIR_CACHE_CP;
        $PT_PAIR_CACHE_CP[$codename]['cc_page_title'] = ($title_to_use === null) ? do_lang_tempcode('NA_EM') : make_string_tempcode($title_to_use);
        $PT_PAIR_CACHE_CP[$codename]['p_parent_page'] = $comcode_page_row['p_parent_page'];
        $comcode_breadcrumbs = comcode_breadcrumbs($codename, $zone, get_param('keep_page_root', ''), ($comcode_page_row['p_parent_page'] == '') || !has_privilege(get_member(), 'open_virtual_roots'));
        breadcrumb_add_segment($comcode_breadcrumbs);

        set_extra_request_metadata(array(
            'created' => date('Y-m-d', $comcode_page_row['p_add_date']),
            'creator' => (is_guest($comcode_page_row['p_submitter'])) ? '' : $GLOBALS['FORUM_DRIVER']->get_username($comcode_page_row['p_submitter']),
            'publisher' => '', // blank means same as creator
            'modified' => ($comcode_page_row['p_edit_date'] === null) ? '' : date('Y-m-d', $comcode_page_row['p_edit_date']),
            'type' => 'Comcode page',
            'title' => $title_to_use,
            'identifier' => $zone . ':' . $codename,
            'description' => '',
            //'category'=>???,
        ));
    }

    if (($GLOBALS['OUTPUT_STREAMING']) && ($out !== null)) {
        $GLOBALS['TEMPCODE_CURRENT_PAGE_OUTPUTTING'] = $out;

        $out->evaluate_echo(null, true);
    }

    if (($html->is_empty_shell()) && ($is_panel)) {
        return $html;
    }

    global $SCREEN_TEMPLATE_CALLED;
    $st = $SCREEN_TEMPLATE_CALLED;
    $ret = do_template('COMCODE_PAGE_SCREEN', array(
        '_GUID' => '0fc4fe4f27e54aaaa2b7e4848c02bacb',
        'IS_PANEL' => $is_panel,
        'BEING_INCLUDED' => $being_included,
        'SUBMITTER' => strval($comcode_page_row['p_submitter']),
        'TAGS' => (get_option('show_content_tagging') == '0') ? /*optimisation, can be intensive with many page includes*/
            new Tempcode() : get_loaded_tags('comcode_pages'),
        'WARNING_DETAILS' => $warning_details,
        'EDIT_DATE_RAW' => ($comcode_page_row['p_edit_date'] === null) ? '' : strval($comcode_page_row['p_edit_date']),
        'SHOW_AS_EDIT' => $comcode_page_row['p_show_as_edit'] == 1,
        'CONTENT' => $html,
        'EDIT_URL' => $edit_url,
        'ADD_CHILD_URL' => $add_child_url,
        'NAME' => $codename,
        'NATIVE_ZONE' => $zone,
    ));
    if (($is_panel) || ($being_included)) {
        $SCREEN_TEMPLATE_CALLED = $st;
    }
    return $ret;
}

/**
 * Get a UI element of a route from a known Comcode page back to the declared root of the tree.
 *
 * @param  ID_TEXT                      $the_page The Comcode page name
 * @param  ID_TEXT                      $the_zone The Comcode page zone
 * @param  ID_TEXT                      $root The virtual root
 * @param  boolean                      $no_link_for_me_sir Whether not to put a link at this point in the navigation tree (usually, because the viewer is already at it)
 * @param  integer                      $jumps The number of jumps we have gone through so far (cuts out after 10 as a failsafe)
 * @return tempcode                     The navigation element
 */
function comcode_breadcrumbs($the_page, $the_zone, $root = '', $no_link_for_me_sir = true, $jumps = 0)
{
    if ($jumps == 10) {
        return new Tempcode();
    }

    $map = array('page' => $the_page);
    if ($jumps == 0) {
        $map['keep_page_root'] = $the_page;
    } elseif ($root != '') {
        $map['keep_page_root'] = $root;
    }
    $url = build_url($map, $the_zone);

    if ($the_page == '') {
        return new Tempcode();
    }
    if ($the_page == $root) {
        if ($no_link_for_me_sir) {
            return new Tempcode();
        }
        $_title = $GLOBALS['SITE_DB']->query_select_value_if_there('cached_comcode_pages', 'cc_page_title', array('the_page' => $the_page, 'the_zone' => $the_zone));
        $title = null;
        if ($_title !== null) {
            $title = get_translated_text($_title, null, null, true);
        }
        if ($_title === null) {
            $title = escape_html($the_page);
        }
        return hyperlink($url, $title, false, false, do_lang_tempcode('GO_BACKWARDS_TO', @html_entity_decode(strip_tags($title), ENT_QUOTES, get_charset())), null, null, 'up');
    }

    global $PT_PAIR_CACHE_CP;
    if (!array_key_exists($the_page, $PT_PAIR_CACHE_CP)) {
        $page_rows = $GLOBALS['SITE_DB']->query_select('cached_comcode_pages a JOIN ' . $GLOBALS['SITE_DB']->get_table_prefix() . 'comcode_pages b ON (a.the_page=b.the_page AND a.the_zone=b.the_zone)', array('cc_page_title', 'p_parent_page', 'string_index'), array('a.the_page' => $the_page, 'a.the_zone' => $the_zone), '', 1, null, false, array('string_index' => 'LONG_TRANS__COMCODE', 'cc_page_title' => '?SHORT_TRANS'));
        if (!array_key_exists(0, $page_rows)) {
            request_page($the_page, false, $the_zone, null, true); // It's not cached, force the issue and then try again...
            $page_rows = $GLOBALS['SITE_DB']->query_select('cached_comcode_pages a JOIN ' . $GLOBALS['SITE_DB']->get_table_prefix() . 'comcode_pages b ON (a.the_page=b.the_page AND a.the_zone=b.the_zone)', array('cc_page_title', 'p_parent_page', 'string_index'), array('a.the_page' => $the_page, 'a.the_zone' => $the_zone), '', 1, null, false, array('string_index' => 'LONG_TRANS__COMCODE', 'cc_page_title' => '?SHORT_TRANS'));
            if (!array_key_exists(0, $page_rows)) { // Oh well, fallback (maybe page doesn't exist yet, ?)...
                $_title = $the_page;
                $PT_PAIR_CACHE_CP[$the_page] = array();
                $PT_PAIR_CACHE_CP[$the_page]['cc_page_title'] = escape_html($_title);
                $PT_PAIR_CACHE_CP[$the_page]['p_parent_page'] = null;
            }
        }
        if (array_key_exists(0, $page_rows)) {
            $PT_PAIR_CACHE_CP[$the_page] = $page_rows[0];
            $_title = get_translated_text($PT_PAIR_CACHE_CP[$the_page]['cc_page_title'], null, null, true);
            if ($_title === null) {
                $_title = $the_page;
            }
            $PT_PAIR_CACHE_CP[$the_page]['cc_page_title'] = $_title;
        }
    }

    $title = $PT_PAIR_CACHE_CP[$the_page]['cc_page_title'];
    if ($title === null) {
        $title = $the_page;
    }
    if (!$no_link_for_me_sir) {
        $tpl_url = ($PT_PAIR_CACHE_CP[$the_page]['p_parent_page'] == '') ? new Tempcode() : do_template('BREADCRUMB_SEPARATOR');
        $_title = is_object($title) ? $title->evaluate() : $title;
        $tooltip = ($jumps == 0) ? do_lang_tempcode('VIRTUAL_ROOT') : do_lang_tempcode('GO_BACKWARDS_TO', @html_entity_decode(strip_tags($_title), ENT_QUOTES, get_charset()));

        $title = symbol_truncator(array($_title, BREADCRUMB_CROP_LENGTH, '1', '1'), 'spread', $tooltip);
        $tpl_url->attach(hyperlink($url, $title, false, false, (strlen($_title) > BREADCRUMB_CROP_LENGTH) ? new Tempcode() : $tooltip, null, null, 'up'));
    } else {
        $tpl_url = new Tempcode();
        if ($jumps == 0) {
            $tpl_url = ($PT_PAIR_CACHE_CP[$the_page]['p_parent_page'] == '') ? new Tempcode() : do_template('BREADCRUMB_SEPARATOR');
            $_title = is_object($title) ? $title->evaluate() : $title;
            if ($_title != '') {
                $tpl_url->attach('<span>' . $_title . '</span>');
            }
        }
    }

    if ($PT_PAIR_CACHE_CP[$the_page]['p_parent_page'] == $the_page) {
        fatal_exit(do_lang_tempcode('RECURSIVE_TREE_CHAIN', escape_html($the_page)));
    }
    $below = comcode_breadcrumbs($PT_PAIR_CACHE_CP[$the_page]['p_parent_page'], $the_zone, $root, false, $jumps + 1);
    $below->attach($tpl_url);

    return $below;
}

/**
 * Log statistics for the page view.
 *
 * @param  string                       $string The string to the page file
 * @param  integer                      $pg_time The time taken for page loading in milliseconds
 */
function log_stats($string, $pg_time)
{
    if (!addon_installed('stats')) {
        return;
    }

    if ((get_option('site_closed') == '1') && (get_option('stats_when_closed') == '1')) {
        return;
    }

    if ((get_option('super_logging') == '1') || (get_param('track', null) !== null)) {
        $get = substr(flatten_slashed_array($_GET), 0, 255);
        $post2 = $_POST;
        unset($post2['password']);
        unset($post2['password_confirm']);
        unset($post2['decrypt']);
        $post = flatten_slashed_array($post2);
    } else {
        $get = '';
        $post = '';
    }
    $page = $string;
    $ip = get_ip_address();
    $session_id = get_session_id();
    $member = get_member();
    $time = time();
    $referer = substr(ocp_srv('HTTP_REFERER'), 0, 255);
    $browser = substr(get_browser_string(), 0, 255);
    $os = substr(get_os_string(), 0, 255);
    if ($os === null) {
        $os = '';
    }

    if ((get_option('bot_stats') == '1') && ((strpos(strtolower($browser), 'http:') !== false) || (strpos(strtolower($browser), 'bot') !== false) || (get_bot_type() !== null))) {
        return;
    }

    $GLOBALS['SITE_DB']->query_insert('stats', array(
        'access_denied_counter' => 0,
        'browser' => $browser,
        'operating_system' => $os,
        'the_page' => $page,
        'ip' => $ip,
        'session_id' => $session_id,
        'member_id' => $member,
        'date_and_time' => $time,
        'referer' => $referer,
        's_get' => $get,
        'post' => $post,
        'milliseconds' => intval($pg_time * 1000)
    ), false, true);
    if (mt_rand(0, 1000) == 1) {
        if (!$GLOBALS['SITE_DB']->table_is_locked('stats')) {
            $GLOBALS['SITE_DB']->query('DELETE FROM ' . get_table_prefix() . 'stats WHERE date_and_time<' . strval(time() - 60 * 60 * 24 * intval(get_option('stats_store_time'))));
        }
    }

    global $SITE_INFO;
    if (isset($SITE_INFO['throttle_bandwidth_views_per_meg'])) {
        if (!$GLOBALS['SITE_DB']->table_is_locked('values')) {
            set_value('page_views', strval(intval(get_value('page_views')) + 1));
        }
    }
}

/* *
 * Output filter to compress HTML.
 *
 * @param  string                       $data The HTML to filter
 * @return string                       Compressed HTML
 */
/*f unction _compress_html_output($data)
{
    return preg_replace(array('#>[ \t]+#', '#[ \t]+<#', '#\n[ \t]+\n#', '#\n+#'), array('> ', ' <', "\n", "\n"), $data);
}*/
